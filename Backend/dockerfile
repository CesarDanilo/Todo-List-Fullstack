# Usa uma imagem oficial do Node.js leve
FROM node:18-alpine

# Define o diretório de trabalho dentro do container
WORKDIR /app

# 1. Copia apenas os arquivos de dependências para cache eficiente
COPY package*.json ./

# 2. Instala as dependências conforme o package.json
RUN npm install

# 3. Copia o restante da aplicação (exceto o que estiver no .dockerignore, como node_modules)
COPY . .

# 4. Copia o arquivo .env caso exista
# Se você quiser garantir que o .env seja copiado, descomente a linha abaixo:
# COPY .env ./

# 5. Exponha a porta que sua aplicação irá rodar
EXPOSE 3001

# 6. Comando para criar DB, rodar migrações e iniciar o servidor
CMD sh -c "\
  npx sequelize db:create --config src/database/config/config.js 2>/dev/null || true && \
  npx sequelize db:migrate --config src/database/config/config.js --migrations-path src/database/migrations && \
  npm run dev"
